name: "test"
description: "Defines the central stepa in testing ns-3"

runs:
  using: "composite"
  steps:
    # Pre-configuration steps
    - name: "Download build artifacts from previous job"
      uses: actions/download-artifact@v3
      with:
        name: ${{ env.BUILD_ID }}
    - name: "Unpack build artifacts for testing"
      run: tar -xf build.tzst -P -C $GITHUB_WORKSPACE --use-compress-program unzstd
      shell: bash
    # Configuration steps
    - name: "Prepare ccache environment"
      run: |
        mkdir -p ns-3-ccache-storage
        echo "CCACHE_BASEDIR=$GITHUB_WORKSPACE" >> $GITHUB_ENV
        echo "CCACHE_DIR=$GITHUB_WORKSPACE/ns-3-ccache-storage" >> $GITHUB_ENV
        echo "MPI_CI=1" >> $GITHUB_ENV
      shell: bash
    - name: "Configure ns-3 CMake"
      run: CXX=$COMPILER ./ns3 configure -d $MODE -GNinja --enable-examples --enable-tests --enable-asserts --enable-werror --enable-modules "lorawan;applications" $EXTRA_OPTIONS
      shell: bash
    # Test steps
    - if: env.MODE != 'debug' && hashFiles(format('build/tests-{0}.txt', github.ref_name)) != ''
      name: "Test ns-3"
      run: >
        ./test.py -n &&
        if [[ $? == 0 ]];
        then `rm build/tests-$GITHUB_REF_NAME.txt` || true;
        fi;
      shell: bash
